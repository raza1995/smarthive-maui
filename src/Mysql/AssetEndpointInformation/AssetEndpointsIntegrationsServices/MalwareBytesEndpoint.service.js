import moment from "moment";
import malwareBytesEndpointAgentInfoModel from "../../../mongo/malwareBytes/EndpointAgentInfo/endpointAgentinfo.model";
import malwareBytesEndpointModel from "../../../mongo/malwareBytes/Endpoints/endpoints.model";
import { macOsModel, windowsOsModel } from "../../../mongo/models/os/osModals";
import { updateOrCreateEndpointInformation } from "../assetEndpointInformation.service";

export const getAssetEndpointInfoFormMalwareBytes = async (asset, source) => {
  const malwareByteEndPoint = await malwareBytesEndpointModel.findOne({
    link: source.device_id,
    company_id: asset.company_id,
  });
  let currentOsVersion = "";
  if (malwareByteEndPoint?.agent?.os_info?.os_platform === "MacOS") {
    const osVersions = await macOsModel.find({}).sort({ release: -1 });
    currentOsVersion = osVersions?.[0]?.cycle;
  } else if (malwareByteEndPoint?.agent?.os_info?.os_platform === "Windows") {
    const osVersions = await windowsOsModel.find({}).sort({ release: -1 });
    currentOsVersion = osVersions?.[0]?.cycleShortHand;
  }
  const link = source.device_id.split("/");
  const deviceId = link[link.length - 1];
  const agentInfo = await malwareBytesEndpointAgentInfoModel.findOne({
    asset_id: deviceId,
    company_id: asset.company_id,
  });

  const data = {
    asset_id: asset.id,
    company_id: asset.company_id,
    integration_id: source.integration_id,
    serial_number: malwareByteEndPoint?.agent.serial_number,
    display_name: malwareByteEndPoint?.display_name,
    location: `${malwareByteEndPoint?.agent?.source_location?.city}, ${malwareByteEndPoint?.agent?.source_location?.country}`,
    os_family: malwareByteEndPoint?.agent?.os_info?.os_platform,
    os_name: malwareByteEndPoint?.agent?.os_info?.os_release_name,
    os_install_version: malwareByteEndPoint?.agent?.os_info?.os_version,
    os_current_version: malwareByteEndPoint ? currentOsVersion : null,
    group: malwareByteEndPoint?.machine?.group_name,
    last_user: malwareByteEndPoint?.agent?.last_user,
    last_seen_at:
      malwareByteEndPoint?.status?.scan_needed?.last_scanned_at ||
      agentInfo?.last_seen_at,
    server_group_id: malwareByteEndPoint?.machine?.root_group_id,
    last_scan_time: malwareByteEndPoint?.machine?.last_scanned_at,
    status: malwareByteEndPoint?.protection_status,
    remediation_required_status:
      malwareByteEndPoint?.status?.remediation_required?.status,
    remediation_required_infection_count:
      malwareByteEndPoint?.status?.remediation_required?.infection_count,
    reboot_required_status:
      malwareByteEndPoint?.status?.reboot_required?.status,
    reboot_required_reasons_count:
      malwareByteEndPoint?.status?.remediation_required?.infection_count,
    suspicious_activity_status:
      malwareByteEndPoint?.status?.suspicious_activity?.status,
    suspicious_activity_count:
      malwareByteEndPoint?.status?.suspicious_activity?.count,
    isolation_status: malwareByteEndPoint?.status?.isolation?.status,
    isolation_process_status: malwareByteEndPoint?.status?.isolation?.process,
    isolation_network_status: malwareByteEndPoint?.status?.isolation?.network,
    isolation_desktop_status: malwareByteEndPoint?.status?.isolation?.desktop,
    scan_needed_status: malwareByteEndPoint?.status?.scan_needed?.status,
    scan_needed_last_seen_at:
      malwareByteEndPoint?.status?.scan_needed?.last_scanned_at,
    scan_needed_job_status: malwareByteEndPoint?.status?.scan_needed?.job_state,
    account_id: malwareByteEndPoint?.machine?.account_id,
  };
  if (data.last_seen_at) {
    const currentDate = moment();
    const last_seen_at = moment(data.last_seen_at);
    const timeDiff = currentDate.diff(last_seen_at, "hours");
    if (timeDiff <= 3) {
      data.risk_score = 850;
    } else if (timeDiff <= 6) {
      data.risk_score = 750;
    } else {
      data.risk_score = 350;
    }
  }
  const resp = updateOrCreateEndpointInformation(data);
  return resp;
};
